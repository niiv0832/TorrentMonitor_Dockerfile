#!/bin/sh

# Populate database if not exists
test -f /data/htdocs/db/tm.sqlite || cp /data/htdocs/db_schema/tm.sqlite /data/htdocs/db/tm.sqlite

# Configure system
# Set PHP timezone
sed -i "s#PHP_TIMEZONE#${PHP_TIMEZONE}#" /etc/php5/php.ini
sed -i "s#PHP_TIMEZONE#${PHP_TIMEZONE}#" /etc/php5/cli/php.ini

# Set PHP memory limit
sed -i "s#PHP_MEMORY_LIMIT#${PHP_MEMORY_LIMIT}#" /etc/php5/php.ini
sed -i "s#PHP_MEMORY_LIMIT#${PHP_MEMORY_LIMIT}#" /etc/php5/cli/php.ini

# Set cront timeuot for engine.php
sed -i "s#CRON_TIMEOUT#${CRON_TIMEOUT}#" /var/spool/cron/crontabs/root

# Set owner for app directory
chown -R nginx:nginx /data/htdocs

# Write temp files by nginx
chmod 777 /tmp

# log for cron
touch /var/log/nginx/torrentmonitor_cron_error.log

#check http-knocking start script
if [ -f /scripts/httpknocking.sh ];
# copy and run http-knocking start script
then
echo -e “Install httpknocking.”
echo "http://dl-cdn.alpinelinux.org/alpine/v3.11/main" >> /etc/apk/repositories
apk --no-cache --repository="http://dl-cdn.alpinelinux.org/alpine/v3.11/main" add nodejs
apk --no-cache --repository="http://dl-cdn.alpinelinux.org/alpine/v3.11/main" add npm
rm -rf /var/cache/apk/*
npm install -g http-knocking
cp /scripts/httpknocking.sh /httpknocking.sh
chmod u+x /httpknocking.sh
/httpknocking.sh
#messging if http-knocking start script hadn't finded
else
echo -e "No http-knockig script.Rerun container with expose only port 80 for direct access to TorMon webui!"
fi

#check rclone start script
if [ -f /scripts/rclonesync.sh ];
# copy and run rclone start script
then
echo -e “Install rclone.”
apk update
apk upgrade
apk --update --no-cache add curl unzip
mkdir -p /tmp/rclone
cd /tmp/rclone
curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
apk del curl
unzip rclone-current-linux-amd64.zip
apk del unzip
cd /tmp/rclone/rclone-*-linux-amd64
cp rclone /usr/bin/
chown root:root /usr/bin/rclone
chmod 755 /usr/bin/rclone
rm -rf /var/cache/apk/*
rm -rf /tmp/rclone
mkdir -p /root/.config/rclone/
cp /scripts/rclone.conf /root/.config/rclone/rclone.conf
cp /scripts/rclonesync.sh /rclonesync.sh
chmod u+x /rclonesync.sh
echo "1-59/2 * * * * /rclonesync.sh" >> /var/spool/cron/crontabs/root
#messging if rclone start script hadn't finded
else
#head -n -1 /var/spool/cron/crontabs/root > /var/spool/cron/crontabs/root.tmp ; mv /var/spool/cron/crontabs/root.tmp /var/spool/cron/crontabs/root
echo -e “No rclone script. rclone remove from cron.”
fi

# Start apps
crond
php-fpm
nginx -g 'daemon off;'

#tail -f /dev/null
